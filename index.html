<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Visit Tracker</title>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link rel="stylesheet" as="style" onload="this.rel='stylesheet'" href="https://fonts.googleapis.com/css2?display=swap&family=Public+Sans:wght@400;500;700;900&display=swap" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        // Initialize Supabase immediately when script loads
        window.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing Supabase...');
        });
    </script>
    <style>
        .hidden { display: none; }
        .form-label { font-weight: 500; color: #111418; margin-bottom: 8px; display: block; }
        .form-input, .form-select, .form-textarea { 
            width: 100%; 
            min-height: 56px; 
            border: 1px solid #dbe0e6; 
            border-radius: 12px; 
            padding: 15px; 
            font-size: 16px; 
            color: #111418; 
            background-color: white; 
        }
        .form-input::placeholder, .form-textarea::placeholder { color: #60758a; }
        .form-select { 
            appearance: none; 
            background-image: url('data:image/svg+xml,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2724px%27 height=%2724px%27 fill=%27rgb(96,117,138)%27 viewBox=%270 0 256 256%27%3e%3cpath d=%27M181.66,170.34a8,8,0,0,1,0,11.32l-48,48a8,8,0,0,1-11.32,0l-48-48a8,8,0,0,1,11.32-11.32L128,212.69l42.34-42.35A8,8,0,0,1,181.66,170.34Zm-96-84.68L128,43.31l42.34,42.35a8,8,0,0,0,11.32-11.32l-48-48a8,8,0,0,0-11.32,0l-48,48A8,8,0,0,0,85.66,85.66Z%27%3e%3c/path%3e%3c/svg%3e'); 
            background-repeat: no-repeat; 
            background-position: right 1rem center; 
            background-size: 1.5em 1.5em; 
        }
        .message { text-align: center; padding: 15px; margin-top: 15px; border-radius: 8px; font-weight: 500;}
        .error-message { color: #c53030; font-size: 0.875rem; margin-top: 0.25rem; }
        .input-error { border-color: #c53030 !important; }
    </style>
</head>
<body class="bg-gray-50" style="font-family: 'Public Sans', sans-serif;">
    <!-- Loader Overlay -->
    <div id="loader" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
    </div>

    <!-- Hidden canvas for image compression -->
    <canvas id="image-canvas" class="hidden"></canvas>

    <div class="max-w-md mx-auto bg-white min-h-screen">
        <!-- Login View -->
        <div id="login-view">
            <div class="p-4">
                <div class="flex items-center justify-end">
                    <button class="text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256">
                            <path d="M140,180a12,12,0,1,1-12-12A12,12,0,0,1,140,180ZM128,72c-22.06,0-40,16.15-40,36v4a8,8,0,0,0,16,0v-4c0-11,10.77-20,24-20s24,9,24,20-10.77,20-24,20a8,8,0,0,0-8,8v8a8,8,0,0,0,16,0v-.72c18.24-3.35,32-17.9,32-35.28C168,88.15,150.06,72,128,72Zm104,56A104,104,0,1,1,128,24,104.11,104.11,0,0,1,232,128Zm-16,0a88,88,0,1,0-88,88A88.1,88.1,0,0,0,216,128Z"></path>
                        </svg>
                    </button>
                </div>
                <div class="flex justify-center mt-4 mb-4">
                    <img src="https://media.licdn.com/dms/image/v2/D5605AQGey5UpD9DIKg/feedshare-thumbnail_720_1280/B56ZVmf_pUHsA8-/0/1741181420574?e=2147483647&v=beta&t=1AB-nShu1DX3ZDSsVmEJAGgSjSGGe7AjseDMV1-D--o" 
                         alt="PW Academy Logo" class="w-24 h-24 rounded-full object-cover">
                </div>
                <h1 class="text-2xl font-bold text-center mb-6">Live Visit Tracker</h1>
                <div id="message-area-login" class="mb-4"></div>
                <input type="email" id="email" placeholder="Enter your email ID" class="form-input mb-4">
                <button onclick="fetchDetails()" class="w-full bg-blue-100 text-blue-800 font-bold py-3 px-4 rounded-full">
                    Fetch Details
                </button>
            </div>
        </div>

        <!-- Form View -->
        <div id="form-view" class="hidden">
            <div class="p-4">
                <div class="flex items-center">
                    <button onclick="goBack()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256">
                            <path d="M165.66,202.34a8,8,0,0,1-11.32,11.32l-80-80a8,8,0,0,1,0-11.32l80-80a8,8,0,0,1,11.32,11.32L91.31,128Z"></path>
                        </svg>
                    </button>
                    <h2 class="text-lg font-bold text-center flex-grow pr-6">Visit Details</h2>
                </div>
            </div>
            
            <form id="visit-form" class="p-4 space-y-6">
                <!-- District filter container, hidden by default -->
                <div id="district-filter-container" class="hidden">
                    <label for="district" class="form-label">District</label>
                    <select id="district" onchange="handleDistrictChange()" class="form-select"></select>
                    <div id="district-error" class="error-message hidden"></div>
                </div>
                
                <div>
                    <label for="school-select-button" class="form-label">School Name</label>
                    <div class="relative" id="school-dropdown-container">
                        <button type="button" id="school-select-button" class="form-input text-left flex justify-between items-center w-full">
                            <span id="school-selected-text" class="truncate text-gray-500">Select School</span>
                            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M10 3a.75.75 0 01.53.22l3.5 3.5a.75.75 0 01-1.06 1.06L10 4.81 6.53 8.28a.75.75 0 01-1.06-1.06l3.5-3.5A.75.75 0 0110 3zm-3.72 9.28a.75.75 0 011.06 0L10 15.19l2.47-2.47a.75.75 0 111.06 1.06l-3.5 3.5a.75.75 0 01-1.06 0l-3.5-3.5a.75.75 0 010-1.06z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div id="school-options-panel" class="hidden absolute z-10 mt-1 w-full bg-white shadow-lg border rounded-md">
                            <div class="p-2">
                                <input type="text" id="school-search-input" placeholder="Search schools..." class="form-input !min-h-0 !py-2 !text-sm" autocomplete="off">
                            </div>
                            <div id="school-options-list" class="max-h-60 overflow-y-auto"></div>
                        </div>
                    </div>
                    <input type="hidden" id="school" name="school">
                    <div id="school-select-button-error" class="error-message hidden"></div>
                </div>
                
                <div>
                    <label for="meeting-outcome" class="form-label">Meeting Outcome</label>
                    <select id="meeting-outcome" class="form-select" onchange="toggleSkuSection()">
                        <option value="">Select Outcome</option>
                        <option>Initial Discussions (Relationship Building/Brochure Discussion/Gifting/Product Demonstration)</option>
                        <option>Change of Book Identified in School, Awaiting Sampling</option>
                        <option>Sample Submission - K_8</option>
                        <option>Prescription Discussion/Finalization (Book List shared by School/Distributor)</option>
                        <option>Book List Out</option>
                        <option>After Sales Engagement</option>
                        <option>Payment Collection</option>
                        <option>Sample Submission Test Prep</option>
                        <option>Meeting did not take place / Meeting postponed</option>
                    </select>
                    <div id="meeting-outcome-error" class="error-message hidden"></div>
                </div>
                
                <div id="sku-section" class="hidden space-y-4 p-4 border border-gray-200 rounded-lg">
                    <h3 class="font-bold text-center">Select SKUs</h3>
                    <div id="sku-container" class="space-y-4"></div>
                    <button type="button" onclick="addSkuBlock()" class="w-full bg-gray-100 text-gray-800 font-bold py-2 px-4 rounded-lg text-sm">
                        Add More Categories
                    </button>
                    <div id="sku-container-error" class="error-message hidden"></div>
                </div>
                
                <div>
                    <label for="spoc" class="form-label">Meeting SPOC</label>
                    <select id="spoc" onchange="toggleNewSpocFields()" class="form-select"></select>
                    <div id="spoc-error" class="error-message hidden"></div>
                </div>
                
                <div id="new-spoc-fields" class="hidden space-y-4 p-4 border border-gray-200 rounded-lg">
                    <h3 class="font-bold text-center">Add New SPOC Details</h3>
                    <div>
                        <label for="new-spoc-designation" class="form-label">Designation</label>
                        <select id="new-spoc-designation" class="form-select">
                            <option value="">-- Select Designation --</option>
                            <option>Teacher</option>
                            <option>Principal</option>
                            <option>coordinator</option>
                            <option>Director</option>
                            <option>Vice-Principal</option>
                            <option>Librarian</option>
                            <option>Admin Team</option>
                        </select>
                        <div id="new-spoc-designation-error" class="error-message hidden"></div>
                    </div>
                    <div>
                        <label for="new-spoc-name" class="form-label">Name</label>
                        <input type="text" id="new-spoc-name" placeholder="Enter Name" class="form-input">
                        <div id="new-spoc-name-error" class="error-message hidden"></div>
                    </div>
                    <div>
                        <label for="new-spoc-contact" class="form-label">Contact</label>
                        <input type="tel" id="new-spoc-contact" placeholder="Enter 10-digit Contact" pattern="\d{10}" class="form-input">
                        <div id="new-spoc-contact-error" class="error-message hidden"></div>
                    </div>
                    <div>
                        <label for="new-spoc-email" class="form-label">Email</label>
                        <input type="email" id="new-spoc-email" placeholder="Enter Email" class="form-input">
                        <div id="new-spoc-email-error" class="error-message hidden"></div>
                    </div>
                </div>
                
                <div>
                    <label for="co-visitor1" class="form-label">Co-Visitor 1</label>
                    <select id="co-visitor1" class="form-select"></select>
                </div>
                
                <div>
                    <label for="co-visitor2" class="form-label">Co-Visitor 2</label>
                    <select id="co-visitor2" class="form-select"></select>
                </div>
                
                <div>
                    <label for="remarks" class="form-label">Remarks</label>
                    <textarea id="remarks" placeholder="Enter Remarks" rows="4" class="form-textarea"></textarea>
                </div>
                
                <div>
                    <label for="follow-up-date" class="form-label">Follow-up Date & Time</label>
                    <input type="datetime-local" id="follow-up-date" class="form-input">
                </div>
                
                <div>
                    <label class="form-label">Capture Image</label>
                    <div id="image-capture-box" class="mt-2 flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-xl p-6 text-center cursor-pointer">
                        <img id="image-preview" class="hidden rounded-xl max-w-full h-auto mx-auto mb-4" alt="Image Preview"/>
                        <div id="image-placeholder">
                            <p class="text-gray-500">No Image Captured</p>
                            <p class="text-sm text-gray-400">Tap to capture an image of the visit.</p>
                        </div>
                        <button type="button" class="mt-4 bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-full text-sm">
                            Capture Image
                        </button>
                    </div>
                    <input type="file" id="image-capture-input" accept="image/*" capture="environment" class="hidden">
                    <div id="image-capture-box-error" class="error-message hidden"></div>
                </div>
                
                <button type="button" onclick="submitForm()" class="w-full bg-blue-500 text-white font-bold py-4 px-4 rounded-full">
                    Submit
                </button>
            </form>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/google-sheets.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
